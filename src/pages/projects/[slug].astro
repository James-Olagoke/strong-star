---
import Layout from '../../layouts/Layout.astro';

// ✅ Load the data INSIDE getStaticPaths with a dynamic import.
// This avoids any Vite/TS resolution hiccups during SSR builds.
export async function getStaticPaths() {
  try {
    const mod = await import('../../data/projects'); // no .ts extension
    const projects = mod.projects ?? [];

    if (!Array.isArray(projects) || projects.length === 0) {
      console.error('[projects/[slug]] No projects found from data file.');
      return [];
    }

    return projects.map((p) => ({
      params: { slug: p.slug },
      props: { project: p },
    }));
  } catch (err) {
    console.error('[projects/[slug]] getStaticPaths import error:', err);
    throw err; // surface the real error in logs
  }
}

const { project } = Astro.props as {
  project: {
    slug: string;
    title: string;
    description: string;
    year: number;
    tags: string[];
    image?: string;
    live?: string;
    code?: string;
    content: {
      overview: string;
      features?: string[];
      tech: string[];
      results?: string[];
    };
  };
};

const { title, description, year, tags, image, live, code, content } = project;
---

<Layout title={title}>
  <!-- Hero -->
  <section class="rounded-2xl overflow-hidden border border-white/10 bg-zinc-900/60" data-animate>
    {image && (
      <div class="relative aspect-[16/7] overflow-hidden">
        <img src={image} alt={title} class="h-full w-full object-cover" loading="lazy" />
        <div class="pointer-events-none absolute inset-0 ring-1 ring-inset ring-white/10"></div>
      </div>
    )}
    <div class="p-6 md:p-8">
      <div class="flex flex-wrap items-center gap-3">
        <h1 class="text-3xl md:text-4xl font-extrabold text-white">{title}</h1>
        <span class="rounded-full bg-indigo-500/20 px-2.5 py-1 text-xs text-indigo-300 border border-indigo-400/20">{year}</span>
      </div>
      <p class="mt-3 text-zinc-400 max-w-3xl">{description}</p>

      <div class="mt-4 flex flex-wrap gap-2">
        {tags.map((t) => (
          <span class="rounded-full border border-white/10 bg-zinc-800/60 px-2.5 py-1 text-xs text-zinc-200 capitalize">{t}</span>
        ))}
      </div>

      <div class="mt-6 flex flex-wrap items-center gap-3">
        {live && <a href={live} class="btn-primary" target={live.startsWith('http') ? '_blank' : undefined} rel="noreferrer">Open Live</a>}
        {code && <a href={code} class="btn-secondary" target="_blank" rel="noreferrer">View Code</a>}
        <a href="/projects" class="btn-secondary">← Back to Projects</a>
      </div>
    </div>
  </section>

  <!-- Body -->
  <section class="mt-10 grid grid-cols-1 lg:grid-cols-3 gap-6">
    <article class="lg:col-span-2 space-y-6">
      <div class="card card-surface" data-animate>
        <h2 class="text-xl font-semibold text-white">Overview</h2>
        <p class="mt-2 text-zinc-400">{content.overview}</p>
      </div>

      {content.features?.length && (
        <div class="card card-surface" data-animate>
          <h2 class="text-xl font-semibold text-white">Key Features</h2>
          <ul class="mt-2 list-disc pl-6 text-zinc-300 space-y-1">
            {content.features!.map((f) => <li>{f}</li>)}
          </ul>
        </div>
      )}

      {content.results?.length && (
        <div class="card card-surface" data-animate>
          <h2 class="text-xl font-semibold text-white">Results</h2>
          <ul class="mt-2 list-disc pl-6 text-zinc-300 space-y-1">
            {content.results!.map((r) => <li>{r}</li>)}
          </ul>
        </div>
      )}
    </article>

    <aside class="space-y-6">
      <div class="card card-surface" data-animate>
        <h3 class="text-lg font-semibold text-white">Tech</h3>
        <ul class="mt-2 grid grid-cols-2 gap-2 text-sm">
          {content.tech.map((t) => (
            <li class="rounded-md border border-white/10 bg-zinc-800/60 px-2.5 py-1 text-zinc-200">{t}</li>
          ))}
        </ul>
      </div>

      <div class="card card-surface" data-animate>
        <h3 class="text-lg font-semibold text-white">Actions</h3>
        <div class="mt-3 flex flex-wrap gap-3">
          {live && <a href={live} class="btn-primary" target={live.startsWith('http') ? '_blank' : undefined} rel="noreferrer">Open Live</a>}
          {code && <a href={code} class="btn-secondary" target="_blank" rel="noreferrer">View Code</a>}
          <a href="/projects" class="btn-secondary">← Back</a>
        </div>
      </div>
    </aside>
  </section>
</Layout>
